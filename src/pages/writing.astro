---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { getCollection } from 'astro:content';

// Lucide icon paths (stroke-based, 24x24 viewBox)
const tagIconPaths: Record<string, { path: string; label: string }> = {
  'music': {
    path: 'M9 18V5l12-2v13 M9 18a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z M21 16a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z',
    label: 'music'
  },
  'productivity': {
    path: 'M10 6h11 M10 12h11 M10 18h11 M3 6l1 1 2-2 M3 12l1 1 2-2 M3 18l1 1 2-2',
    label: 'productivity'
  },
  'work': {
    path: 'M16 20V4a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16 M2 10h20 M2 20h20 M2 10a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2Z',
    label: 'work'
  },
  'life': {
    path: 'M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z',
    label: 'life'
  },
  'kanban': {
    path: 'M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18',
    label: 'kanban'
  },
  'podcast': {
    path: 'M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z M19 10v2a7 7 0 0 1-14 0v-2 M12 19v3',
    label: 'podcast'
  },
  'book-notes': {
    path: 'M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z',
    label: 'book-notes'
  },
  'ai': {
    path: 'M12 8V4H8 M12 8a4 4 0 1 1-8 0 4 4 0 0 1 8 0Z M16 4h4v4 M20 8a4 4 0 1 1-8 0 4 4 0 0 1 8 0Z M8 20H4v-4 M4 16a4 4 0 1 1 8 0 4 4 0 0 1-8 0Z M16 20h4v-4 M20 16a4 4 0 1 1-8 0 4 4 0 0 1-8 0Z',
    label: 'ai'
  },
  'writing': {
    path: 'M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z M15 5l4 4',
    label: 'writing'
  },
  'week-notes': {
    path: 'M8 2v4 M16 2v4 M3 10h18 M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Z',
    label: 'week-notes'
  },
};

// Default icon for posts without tags or unknown tags
const defaultIcon = {
  path: 'M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z M14 2v4a2 2 0 0 0 2 2h4 M10 9H8 M16 13H8 M16 17H8',
  label: 'article'
};

// Get icon for a post based on its first tag
function getPostIcon(tags?: string[]) {
  if (!tags || tags.length === 0) return defaultIcon;
  const firstTag = tags[0];
  return tagIconPaths[firstTag] || defaultIcon;
}

const posts = await getCollection('blog');

// Sort posts by date (newest first)
const sortedPosts = posts.sort(
  (a, b) => new Date(b.data.date).valueOf() - new Date(a.data.date).valueOf()
);

// Group posts by year
const postsByYear = sortedPosts.reduce((acc, post) => {
  const year = new Date(post.data.date).getFullYear();
  if (!acc[year]) {
    acc[year] = [];
  }
  acc[year].push(post);
  return acc;
}, {} as Record<number, typeof sortedPosts>);

// Get years in descending order
const years = Object.keys(postsByYear)
  .map(Number)
  .sort((a, b) => b - a);

// Format date helper
function formatDate(date: Date): string {
  return new Intl.DateTimeFormat('en-GB', {
    day: 'numeric',
    month: 'short',
  }).format(date);
}
---

<BaseLayout title="Writing" description="Articles on productivity, software delivery, and music.">
  <Header />

  <main class="flex-1">
    <div class="mx-auto max-w-3xl px-4 py-12 sm:px-6 sm:py-16">
      <header class="mb-12">
        <h1 class="font-heading text-display mb-4">Writing</h1>
        <p class="text-subtitle">
          {sortedPosts.length} articles on productivity, software, and music.
        </p>
      </header>

      <div class="space-y-12">
        {years.map((year) => (
          <section>
            <h2 class="font-heading text-xl font-semibold mb-6 text-text-muted dark:text-text-dark-muted">
              {year}
            </h2>
            <ul class="space-y-4">
              {postsByYear[year].map((post) => {
                const icon = getPostIcon(post.data.tags);
                return (
                  <li>
                    <a
                      href={`/blog/${post.slug}`}
                      class="group flex items-center gap-4"
                    >
                      <time
                        datetime={post.data.date.toISOString()}
                        class="shrink-0 w-16 text-sm text-text-muted dark:text-text-dark-muted tabular-nums"
                      >
                        {formatDate(new Date(post.data.date))}
                      </time>
                      <span
                        class="shrink-0 text-text-muted dark:text-text-dark-muted group-hover:text-accent dark:group-hover:text-accent-dark transition-colors"
                        title={icon.label}
                      >
                        <svg
                          class="w-4 h-4"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        >
                          <path d={icon.path} />
                        </svg>
                      </span>
                      <span class="font-medium text-text group-hover:text-accent dark:text-text-dark dark:group-hover:text-accent-dark transition-colors">
                        {post.data.title}
                      </span>
                    </a>
                  </li>
                );
              })}
            </ul>
          </section>
        ))}
      </div>
    </div>
  </main>

  <Footer />
</BaseLayout>
